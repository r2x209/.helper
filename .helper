# ---[ Configuration ]----------------------------------------------------------

_NAME=".helper"
_VERSION="22.08.01"
_REPO="https://raw.githubusercontent.com/xa2099/.helper.sh/main"
_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
_THIS="${_DIR}/.helper"
_LIST="${_DIR}/.helper.lst"
_HELP="${_DIR}/.helper.md"
_EDITOR="nano"
_DIRECTORIES=()
_COMMANDS=()
_FILES=()

# ---[ Help ]-------------------------------------------------------------------

help=(
    "$_NAME"
    '-----------------------------------------'
    ''
    '.h   Help (this menu).'
    '.m   Manual.'
    ''
    '.d   Directory to change to.'
    '.dr  Directory Remove from the list.'
    ''
    '.c   Command to execute.'
    '.cl  Command Load as last history item.'
    '.cr  Command Remove from the list.'
    ''
    '.f   File edit.'
    '.fr  File Remove from the list.'
    ''
    '.lg  List Get.'
    '.lp  List Print.'
    '.lr  List Remove.'
    ''
    '.r   Remove .helper and associated files.'
    '.u   Update to the latest version.'
    '.v   Script version.'
    ''
    '-----------------------------------------'
    "                              v. $_VERSION"
)

# ---[ Internal Functions ]-----------------------------------------------------

function .header
{
    local pad="$(printf '%0.1s' '-'{1..500})"
    printf '\n\n\n---%b%*.*s\n\n' "[ $@ ]" 0 "$(($(tput cols)-10-${#1}))" "$pad"
}
function .msg
{
    printf "\n---[ %b\n\n\n" "$1"
}

function .splash
{
    local pad
    pad="$(printf '%0.1s' ' '{1..500})"
    for (( i=0; i<$(($(tput lines) / 2)); i++)); do
        printf "\n"
    done
    printf '%*.*s%b\n ' 0 "$((($(tput cols)-2-${#1})/2))" "$pad" "$1"
    for (( i=0; i<$(($(tput lines) / 2)); i++)); do
        printf "\n"
    done
}

function .forget
{
    history -d $(history 1)
}

function .remember
{
    history -s "$@"
}

function .load
{
    local list target
    if [ -f "$@" ]; then
        mapfile -t list < "$@"
        for line in "${list[@]}"; do
            if [[ ! -z "$line" ]]; then
                if [ '###' == "${line:0:3}" ]; then
                    target=${line:4}
                    printf "\nTarget : %b\n" "${target/_}"
                else
                    if [ $target == "_DIRECTORIES" ]; then
                        if [[ " ${_DIRECTORIES[*]} " =~ " ${line} " ]]; then
                            printf "  Skip : %s\n" "${line}"
                        else
                            _DIRECTORIES[${#_DIRECTORIES[@]}]="$line"
                            printf "   Add : %s\n" "${line}"
                        fi
                    elif [ $target == "_FILES" ]; then
                        if [[ " ${_FILES[*]} " =~ " ${line} " ]]; then
                            printf "  Skip : %s\n" "${line}"
                        else
                            _FILES[${#_FILES[@]}]="$line"
                            printf "   Add : %s\n" "${line}"
                        fi
                    elif [ $target == "_COMMANDS" ]; then
                        if [[ " ${_COMMANDS[*]} " =~ " ${line} " ]]; then
                            printf "  Skip : %s\n" "${line}"
                        else
                            _COMMANDS[${#_COMMANDS[@]}]="$line"
                            printf "   Add : %s\n" "${line}"
                        fi
                    fi
                fi
            fi
        done
    fi
}

function .save
{
    echo "### _DIRECTORIES" > "$_LIST"
    for item in "${_DIRECTORIES[@]}"; do
        echo "$item" >> "$_LIST"
    done
    echo "" >> "$_LIST"
    echo "### _FILES" >> "$_LIST"
    for item in "${_FILES[@]}"; do
        echo "$item" >> "$_LIST"
    done
    echo "" >> "$_LIST"
    echo "### _COMMANDS" >> "$_LIST"
    for item in "${_COMMANDS[@]}"; do
        echo "$item" >> "$_LIST"
    done
}

# ---[ Helper Function ]--------------------------------------------------------

function .b
{
    .forget
    cd -
}

function .c
{
    .forget
    if [ -z "$@" ]; then
        .header "Execute"
        COLUMNS=0
        select option in "${_COMMANDS[@]}"; do
            .msg "Executed : $option"
            .remember "$option"
            eval "$option"
            break
        done
    else
        .remember "$@"
        eval "$@"
        if [[ ! " ${_COMMANDS[*]} " =~ " $@ " ]]; then
            _COMMANDS[${#_COMMANDS[@]}]="$@"
            .save
        fi
    fi
}

function .cl
{
    local list
    .forget
    .header "Load to History"
    COLUMNS=0
    select option in "${_COMMANDS[@]}"; do
        .remember "${option}"
        .msg "Loaded : '$option'"
        break
    done
}

function .cr
{
    .forget
    .header "Remove"
    COLUMNS=0
    select option in "${_COMMANDS[@]}"; do
        unset _COMMANDS[$((REPLY - 1))]
        .save
        .msg "Removed : $option"
        break
    done
}

function .d
{
    local list
    .forget
    if [ -z "$@" ]; then
        .header "Change To"
        COLUMNS=0
        select option in "${_DIRECTORIES[@]}"; do
            if [ -d $1 ]; then
                .msg "Changed to : $option"
                eval "cd $option"
                break
            else
                .msg "Error : '$1' Does not exist."
            fi
        done
    else
        if [ -d $@ ]; then
            if [[ ! " ${_DIRECTORIES[*]} " =~ " ${@} " ]]; then
                _DIRECTORIES[${#_DIRECTORIES[@]}]="$@"
                .save
            fi
            eval "cd $@"
        else
             .msg "Error : '$@' Does not exist."
        fi
    fi
}

function .dr
{
    local list
    .forget
    .header "Remove"
    COLUMNS=0
    select option in "${_DIRECTORIES[@]}"; do
        unset _DIRECTORIES[$((REPLY - 1))]
        .save
        .msg "Removed : $option"
        break
    done
}

function .f
{
    local list
    .forget
    if [ -z "$@" ]; then
        .header "Edit"
        COLUMNS=0
        select option in "${_FILES[@]}"; do
            if [ -f $option ]; then
                if [ -w $option  ]; then
                    .remember "${_EDITOR} $option"
                    eval "${_EDITOR} $option"
                else
                    .remember "sudo ${_EDITOR} $option"
                    eval "sudo ${_EDITOR} $option"
                fi
                break
            else
                .msg "Error : '$option' File does not exist."
            fi
        done
    else
        if [[ ! " ${_FILES[*]} " =~ " ${@} " ]]; then
            _FILES[${#_FILES[@]}]="$@"
            .save
        fi
        if [[ -f "$@" && ! -w "$@" ]]; then
            .remember "sudo ${_EDITOR} $@"
            eval "sudo ${_EDITOR} $@"
        else
            .remember "${_EDITOR} $@"
            eval "${_EDITOR} $@"
        fi
    fi
}

function .fr
{
    local list
    .forget
    .header "Remove"
    COLUMNS=0
    select option in "${_FILES[@]}"; do
        unset _FILES[$((REPLY - 1))]
        .save
        .msg "Removed : $option"
        break
    done
}

function .h
{
    local pad vpad longest
    .forget
    pad="$(printf '%0.1s' ' '{1..500})"
    longest=0
    for line in "${help[@]}"; do
        if [ $longest -lt ${#line} ]; then
            longest=${#line}
        fi
    done
    for ((i=0; i<$((($(tput lines)-${#help[@]})/2)); i++)); do
        vpad+="\n"
    done
    printf "$vpad"
    for line in "${help[@]}"; do
        printf '%*.*s%s\n' 0 "$((($(tput cols)-$longest)/2))" "$pad" "$line"
    done
    printf "$vpad"
}

function .l
{
    .forget
    ls -alh --group-directories-first "$@"
}

function .lg
{
    local menu list target target_list
    .forget
    wget --no-cache -q -O "${_TEMP}" "${_REPO}/lists/.menu"
    mapfile -t menu < "${_TEMP}"
    rm -f "${_TEMP}"
    .header "List Get"
    COLUMNS=0
    select option in "${menu[@]}"; do
        .msg "Loading '$option' lists."
        wget --no-cache -q -O "${_TEMP}" "${_REPO}/lists/${option}.lst"
        mapfile -t list < "${_TEMP}"
        .load "${_TEMP}"
        rm -f "${_TEMP}"
        break
    done
    .save
}

function .lp
{
    .forget
    .header "List"
    cat "${_LIST}"
    printf "\n\n"
}

function .lr
{
    local agree
    .forget
    .header "Empty the list."
    read -e -p "---[ Are you sure? Type 'yes' to agree. : " agree
    if [ "${agree}" == "yes" ]; then
        echo " " > "${_LIST}"
    fi
    _DIRECTORIES=()
    _FILES=()
    _COMMANDS=()
}

function .m
{
    .forget
    if [ ! -f "${_HELP}" ]; then
        wget --no-cache -q -O "${_HELP}" "${_REPO}/readme.md"
    fi
    if [ -f "${_HELP}" ]; then
        cat "${_HELP}" | more
    else
        .msg "Error : Could not download."
    fi
}

function .r
{
    local agree
    .forget
    .header "Remove .helper and all associated files."
    read -e -p "---[ Are you sure? Type 'yes' to agree. : " agree
    if [ "${agree}" == "yes" ]; then
        .remember "rm -f ${_THIS}*"
        eval "rm -f ${_THIS}*"
    fi
}

function .u
{
    .forget
    .remember "wget --no-cache -q -O ${_THIS} ${_REPO}/.helper"
    eval "wget --no-cache -q -O ${_THIS} ${_REPO}/.helper"
    .remember "source ${_THIS}"
    eval "source ${_THIS}"
}

function .v
{
    .forget
    .splash "$_NAME  |  $_VERSION"
}

# ---[ Autorun ]----------------------------------------------------------------

.load "$_LIST"
.splash "$_NAME  |  run .h"
